<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Outfit', sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--navy) 0%, #1a1a1a 100%);
            padding: 1rem 0;
        }
    </style>
</head>

<body class="bg-premium">
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold fs-4" href="dashboard.html">
                <img src="https://img.icons8.com/isometric/50/coins.png" width="30" class="me-2">Admin Panel
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link fw-medium px-3 text-white-50"
                            href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active fw-medium px-3 text-white" href="funds.html">Manage
                            Funds</a></li>
                    <li class="nav-item"><a class="nav-link fw-medium px-3 text-white-50" href="users.html">Manage
                            Users</a></li>
                </ul>
                <button class="btn btn-outline-light btn-sm px-3" onclick="Auth.logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-end mb-4 animate-fade-in">
            <div>
                <h1 class="fw-bold mb-1">Fund Repository</h1>
                <p class="text-muted mb-0">Configure and monitor your financial products</p>
            </div>
            <button class="btn btn-primary px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#fundModal">
                <i class="bi bi-plus-lg me-2"></i>Create New Fund
            </button>
        </div>

        <div class="card glass-card border-0 p-3 animate-fade-in">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover smart-table align-middle">
                        <thead>
                            <tr>
                                <th class="border-0 text-muted small text-uppercase">Fund Identity</th>
                                <th class="border-0 text-muted small text-uppercase">Goal Target</th>
                                <th class="border-0 text-muted small text-uppercase">Tenure</th>
                                <th class="border-0 text-muted small text-uppercase">Enrollment</th>
                                <th class="border-0 text-muted small text-uppercase">Frequency</th>
                                <th class="border-0 text-muted small text-uppercase text-center">Lifecycle</th>
                                <th class="border-0 text-muted small text-uppercase text-end">Control</th>
                            </tr>
                        </thead>
                        <tbody id="fundTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal fade" id="fundModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Fund Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="fundForm">
                        <input type="hidden" id="fundId">
                        <div class="mb-3">
                            <label class="form-label">Fund Name</label>
                            <input type="text" id="name" class="form-control" required
                                placeholder="e.g., Monthly Savings 2024">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Total Goal Amount</label>
                                <input type="number" id="total_amount" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Duration (Terms)</label>
                                <input type="number" id="duration" class="form-control" required placeholder="e.g. 50">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Frequency Type</label>
                            <select id="type" class="form-select">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" id="start_date" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date</label>
                                <input type="date" id="end_date" class="form-control">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Terms & Conditions</label>
                            <textarea id="terms" class="form-control" rows="4"
                                placeholder="Enter fund-specific terms and conditions here..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Save Fund</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Member List Modal -->
    <div class="modal fade" id="memberListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memberModalLabel">Fund Members</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Joined On</th>
                                    <th>Paid</th>
                                    <th>Pending</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="memberListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collect Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Collect Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="pay_user_id">
                        <input type="hidden" id="pay_fund_id">
                        <input type="hidden" id="pay_monthly_target">

                        <div class="mb-3">
                            <label class="form-label">Select Month</label>
                            <input type="month" id="pay_month" class="form-control" required
                                onchange="calculateSuggestedAmount()">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Schedule</label>
                            <select id="pay_schedule" class="form-select" onchange="calculateSuggestedAmount()">
                                <option value="monthly">Monthly</option>
                                <option value="weekly">Weekly</option>
                                <option value="daily">Daily</option>
                            </select>
                        </div>
                        <div class="alert alert-info py-2 mb-3" id="paymentInfo">
                            <!-- Info text about weeks/days will appear here -->
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Amount (₹)</label>
                            <input type="number" id="pay_amount" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Mode</label>
                            <select id="pay_mode" class="form-select">
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Record Payment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/api.js"></script>
    <script>
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
        if (!Auth.isAdmin()) window.location.href = '../index.html';

        async function loadFunds() {
            try {
                const funds = await apiRequest('/funds', 'GET', null, Auth.getToken());
                const tbody = document.getElementById('fundTable');
                tbody.innerHTML = funds.map(f => `
                    <tr>
                        <td>
                            <div class="fw-bold text-navy">
                                ${f.name} 
                                ${f.terms ? '<i class="bi bi-file-earmark-text-fill text-info ms-1" title="Terms & Conditions Applied"></i>' : ''}
                            </div>
                            <div class="small text-muted">Ref: #${f.id}</div>
                        </td>
                        <td class="fw-bold">₹${f.total_amount.toLocaleString()}</td>
                        <td>
                            <div class="small fw-semibold text-dark">${f.duration} Units</div>
                            <div class="text-muted" style="font-size: 0.7rem;">${f.type === 'daily' ? 'DAILY CYCLE' : f.type === 'weekly' ? 'WEEKLY CYCLE' : 'MONTHLY CYCLE'}</div>
                        </td>
                        <td>
                            <span class="badge bg-primary-light text-primary rounded-pill px-3">${f.member_count} Members</span>
                        </td>
                        <td>
                            <span class="text-uppercase small fw-bold text-muted">${f.type}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge ${f.status === 'active' ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary'} rounded-pill px-3">
                                ${f.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="text-end">
                            <div class="btn-group shadow-sm rounded-3 overflow-hidden">
                                <button class="btn btn-sm btn-light border-end" title="View Members" onclick="viewMembers(${f.id}, '${f.name.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-people text-primary"></i>
                                </button>
                                <a class="btn btn-sm btn-light border-end" title="Track Progress" href="tracking.html?id=${f.id}">
                                    <i class="bi bi-graph-up text-success"></i>
                                </a>
                                <button class="btn btn-sm btn-light border-end" title="Edit" onclick="editFund(${f.id})">
                                    <i class="bi bi-pencil-square text-dark"></i>
                                </button>
                                <button class="btn btn-sm btn-light" title="Delete" onclick="deleteFund(${f.id}, '${f.name.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-trash text-danger"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (err) { alert(err.message); }
        }

        async function deleteFund(id, name) {
            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete "${name}". This will permanently remove the fund and all associated member enrollments!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete fund!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await apiRequest(`/funds/${id}`, 'DELETE', null, Auth.getToken());
                        loadFunds();
                        Toast.fire({
                            icon: 'success',
                            title: 'Fund deleted successfully'
                        });
                    } catch (err) {
                        Swal.fire('Error!', err.message, 'error');
                    }
                }
            });
        }

        async function editFund(id) {
            try {
                const funds = await apiRequest('/funds', 'GET', null, Auth.getToken());
                const fund = funds.find(f => f.id === id);
                if (!fund) return alert('Fund not found');

                document.getElementById('fundId').value = fund.id;
                document.getElementById('name').value = fund.name;
                document.getElementById('total_amount').value = fund.total_amount;
                document.getElementById('duration').value = fund.duration;
                document.getElementById('type').value = fund.type;
                document.getElementById('start_date').value = fund.start_date ? fund.start_date.split('T')[0] : '';
                document.getElementById('end_date').value = fund.end_date ? fund.end_date.split('T')[0] : '';
                document.getElementById('terms').value = fund.terms || '';

                document.querySelector('#fundModal .modal-title').textContent = 'Edit Fund';
                document.querySelector('#fundForm button[type="submit"]').textContent = 'Update Fund';

                new bootstrap.Modal(document.getElementById('fundModal')).show();
            } catch (err) {
                alert(err.message);
            }
        }

        // Reset form on modal close
        document.getElementById('fundModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('fundForm').reset();
            document.getElementById('fundId').value = '';
            document.querySelector('#fundModal .modal-title').textContent = 'Create New Fund';
            document.querySelector('#fundForm button[type="submit"]').textContent = 'Save Fund';
        });

        document.getElementById('fundForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('fundId').value;

            const formData = {
                name: document.getElementById('name').value,
                total_amount: document.getElementById('total_amount').value,
                duration: document.getElementById('duration').value,
                type: document.getElementById('type').value,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                terms: document.getElementById('terms').value
            };

            try {
                if (id) {
                    await apiRequest(`/funds/${id}`, 'PUT', formData, Auth.getToken());
                    Toast.fire({ icon: 'success', title: 'Fund updated successfully' });
                } else {
                    await apiRequest('/funds', 'POST', formData, Auth.getToken());
                    Toast.fire({ icon: 'success', title: 'Fund created successfully' });
                }

                bootstrap.Modal.getInstance(document.getElementById('fundModal')).hide();
                loadFunds();
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            }
        });

        async function viewMembers(fundId, fundName) {
            document.getElementById('memberModalLabel').textContent = `Members of ${fundName}`;
            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

            const modal = new bootstrap.Modal(document.getElementById('memberListModal'));
            modal.show();

            try {
                const fund = (await apiRequest('/funds', 'GET', null, Auth.getToken())).find(f => f.id === fundId);
                const monthlyTarget = fund.total_amount / fund.duration;

                const members = await apiRequest(`/funds/${fundId}/members`, 'GET', null, Auth.getToken());
                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No members enrolled yet.</td></tr>';
                } else {
                    tbody.innerHTML = members.map(m => `
                        <tr>
                            <td>${m.name}</td>
                            <td>${m.email}</td>
                            <td>${new Date(m.joined_at).toLocaleDateString()}</td>
                            <td class="text-success">₹${m.total_paid}</td>
                            <td class="text-danger">₹${m.pending_balance}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="openPaymentModal(${m.id}, ${fundId}, ${monthlyTarget})">
                                    <i class="bi bi-cash"></i> Pay
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) { alert(err.message); }
        }

        let paymentModal;
        function openPaymentModal(userId, fundId, monthlyTarget) {
            document.getElementById('pay_user_id').value = userId;
            document.getElementById('pay_fund_id').value = fundId;
            document.getElementById('pay_monthly_target').value = monthlyTarget;

            // Default to current month
            const now = new Date();
            document.getElementById('pay_month').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            calculateSuggestedAmount();

            paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();
        }

        function calculateSuggestedAmount() {
            const monthStr = document.getElementById('pay_month').value;
            const schedule = document.getElementById('pay_schedule').value;
            const monthlyTarget = parseFloat(document.getElementById('pay_monthly_target').value);
            const infoBox = document.getElementById('paymentInfo');
            const amountInput = document.getElementById('pay_amount');

            if (!monthStr || isNaN(monthlyTarget)) return;

            const [year, month] = monthStr.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();

            // Simple logic: Get number of specific days (e.g. Mondays) or just roughly 
            // In a real app, you might want specific weeks. For now, let's use a standard 
            // calculation of 4 or 5 based on days.
            const weeksInMonth = Math.ceil(daysInMonth / 7);

            let suggested = monthlyTarget;
            let text = `Monthly goal is ₹${monthlyTarget.toLocaleString()}.`;

            if (schedule === 'weekly') {
                suggested = monthlyTarget / weeksInMonth;
                text += ` This month has ${weeksInMonth} weeks. Suggested weekly payment: <strong>₹${suggested.toFixed(2)}</strong>`;
            } else if (schedule === 'daily') {
                suggested = monthlyTarget / daysInMonth;
                text += ` This month has ${daysInMonth} days. Suggested daily payment: <strong>₹${suggested.toFixed(2)}</strong>`;
            } else {
                text += ` Suggested monthly payment: <strong>₹${monthlyTarget.toLocaleString()}</strong>`;
            }

            infoBox.innerHTML = text;
            amountInput.value = suggested.toFixed(0);
        }

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                user_id: document.getElementById('pay_user_id').value,
                fund_id: document.getElementById('pay_fund_id').value,
                amount: document.getElementById('pay_amount').value,
                payment_month: document.getElementById('pay_month').value,
                payment_schedule: document.getElementById('pay_schedule').value,
                mode: document.getElementById('pay_mode').value,
                payment_date: new Date().toISOString().split('T')[0]
            };

            try {
                await apiRequest('/payments', 'POST', data, Auth.getToken());
                paymentModal.hide();
                Swal.fire('Success', 'Payment recorded successfully!', 'success');
                // Refresh member list if visible? For simplicity, just reload or rely on user closing.
                // Re-calling viewMembers would be better.
                viewMembers(data.fund_id, document.getElementById('memberModalLabel').textContent.replace('Members of ', ''));
            } catch (err) { alert(err.message); }
        });

        loadFunds();
    </script>
</body>

</html>