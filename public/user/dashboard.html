<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Outfit', sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--navy) 0%, var(--primary-dark) 100%);
            padding: 1rem 0;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="bg-premium">
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold fs-4" href="#">
                <img src="https://img.icons8.com/isometric/50/coins.png" width="30" class="me-2">Smart Fund
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active fw-medium px-3 text-white" href="dashboard.html">My
                            Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link fw-medium px-3" href="passbook.html">My Passbook</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="text-light me-3 text-end d-none d-md-block">
                        <small class="d-block opacity-75">Welcome back,</small>
                        <span id="userName" class="fw-bold"></span>
                    </div>
                    <button class="btn btn-glass-light btn-sm px-3" onclick="Auth.logout()">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card glass-card border-0">
                    <div class="card-body p-4">
                        <div class="stat-icon bg-primary-light text-primary"><i class="bi bi-grid-1x2"></i></div>
                        <div class="text-muted small fw-bold text-uppercase tracking-wider">Joined Funds</div>
                        <h2 id="joinedFunds" class="fw-bold mb-0">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card glass-card border-0">
                    <div class="card-body p-4">
                        <div class="stat-icon bg-success-subtle text-success"><i class="bi bi-graph-up-arrow"></i></div>
                        <div class="text-muted small fw-bold text-uppercase tracking-wider">Total Paid</div>
                        <h2 id="totalPaid" class="fw-bold mb-0 text-success">₹0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card glass-card border-0">
                    <div class="card-body p-4">
                        <div class="stat-icon bg-danger-subtle text-danger"><i class="bi bi-hourglass-split"></i></div>
                        <div class="text-muted small fw-bold text-uppercase tracking-wider">Pending Balance</div>
                        <h2 id="pendingBalance" class="fw-bold mb-0 text-danger">₹0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">My Invested Funds</h4>
            <a href="passbook.html" class="btn btn-outline-primary btn-sm">View Passbook</a>
        </div>
        <div id="fundList" class="row g-3 mb-5">
            <!-- Fund Cards will be injected here -->
        </div>

        <h4 class="mb-3">Available Funds to Join</h4>
        <div id="availableFunds" class="row g-3 mb-5">
            <!-- Available Funds will be injected here -->
        </div>

        <!-- Quick Payment Floating Button -->
        <div class="position-fixed bottom-0 end-0 m-4">
            <button class="btn btn-primary btn-lg rounded-pill shadow-lg" data-bs-toggle="modal"
                data-bs-target="#payModal">
                <i class="bi bi-plus-lg me-2"></i>Make Payment
            </button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="payModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit Money</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">Select Fund</label>
                            <select id="selFund" class="form-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Month</label>
                            <input type="month" id="pay_month" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Schedule</label>
                            <select id="payment_schedule" class="form-select">
                                <option value="monthly">Monthly</option>
                                <option value="weekly">Weekly</option>
                                <option value="daily">Daily</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount (₹)</label>
                            <input type="number" id="amount" class="form-control" required
                                placeholder="e.g., 500, 1000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Mode</label>
                            <select id="mode" class="form-select">
                                <option value="UPI">UPI</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" id="date" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Confirm Payment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Fund Modal -->
    <div class="modal fade" id="joinModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enroll in Fund</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="joinForm">
                        <input type="hidden" id="joinFundId">
                        <div class="mb-3">
                            <label class="form-label">Fund Name</label>
                            <input type="text" id="joinFundName" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Payment Schedule</label>
                            <select id="paymentSchedule" class="form-select" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                            </select>
                            <div class="form-text text-muted">This schedule is for your records and reminders.</div>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Join Fund Now</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/api.js"></script>
    <script>
        if (!Auth.isLoggedIn()) window.location.href = '../index.html';
        document.getElementById('userName').textContent = Auth.getUser().name;
        document.getElementById('date').valueAsDate = new Date();

        // Default to current month
        const _now = new Date();
        document.getElementById('pay_month').value = `${_now.getFullYear()}-${String(_now.getMonth() + 1).padStart(2, '0')}`;

        async function loadDashboard() {
            try {
                const token = Auth.getToken();
                const summary = await apiRequest('/dashboard/user/summary', 'GET', null, token);
                const allFunds = await apiRequest('/funds', 'GET', null, token);

                document.getElementById('joinedFunds').textContent = summary.fundsJoined;
                document.getElementById('totalPaid').textContent = `₹${summary.totalPaid.toLocaleString()}`;
                document.getElementById('pendingBalance').textContent = `₹${summary.pendingBalance.toLocaleString()}`;

                // Render Invested Funds
                const fundList = document.getElementById('fundList');
                if (summary.funds.length === 0) {
                    fundList.innerHTML = '<div class="col-12"><div class="card glass-card p-5 text-center text-muted">You haven\'t joined any funds yet. Browse available funds below!</div></div>';
                } else {
                    fundList.innerHTML = summary.funds.map(f => `
                        <div class="col-md-6">
                            <div class="card glass-card border-0 h-100 p-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h5 class="fw-bold mb-1">${f.name}</h5>
                                            <span class="badge bg-primary-light text-primary text-uppercase px-2" style="font-size: 0.65rem; letter-spacing: 0.5px;">${f.payment_schedule}</span>
                                        </div>
                                        <div class="text-end">
                                            <div class="small text-muted mb-0">Target</div>
                                            <div class="fw-bold">₹${f.total_amount.toLocaleString()}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="small fw-semibold">Growth Tracking</span>
                                            <span class="small fw-bold text-primary">${f.progress}%</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar" style="width: ${f.progress}%"></div>
                                        </div>
                                    </div>

                                    <div class="row g-2 mb-4">
                                        <div class="col-6">
                                            <div class="p-2 rounded-3 bg-light">
                                                <div class="small text-muted mb-0">Paid</div>
                                                <div class="fw-bold text-success small">₹${f.total_paid.toLocaleString()}</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 rounded-3 bg-light">
                                                <div class="small text-muted mb-0">Pending</div>
                                                <div class="fw-bold text-danger small">₹${f.pending_balance.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                                        <div class="small">
                                            <i class="bi bi-calendar3 me-1 text-primary"></i> Next: <span class="fw-bold">${f.next_due_date}</span>
                                        </div>
                                        ${f.overdueMonths > 0 ? `<span class="badge bg-danger rounded-pill px-3">Overdue</span>` : '<span class="badge bg-success-subtle text-success rounded-pill px-3">On Track</span>'}
                                    </div>
                                    
                                    <div class="mt-3 p-3 bg-white bg-opacity-50 rounded-3 border border-white">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="small fw-medium text-muted">Next Due (Current Month)</span>
                                            <span class="small fw-bold ${f.currentMonthBalance > 0 ? 'text-danger' : 'text-success'}">
                                                ${f.currentMonthBalance > 0 ? `₹${f.currentMonthBalance.toLocaleString()} Left` : 'Fully Paid'}
                                            </span>
                                        </div>
                                        ${f.currentMonthBalance > 0 ? `
                                            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                                                <div class="small text-muted">
                                                    ${f.payment_schedule === 'weekly' ?
                                `<i class="bi bi-info-circle me-1"></i> ${f.weeksInMonth} weeks this month` :
                                `<i class="bi bi-info-circle me-1"></i> ${f.daysInMonth} days this month`}
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-primary rounded-pill">
                                                        ${f.payment_schedule === 'weekly' ? `₹${f.recommendedWeekly}/week` :
                                f.payment_schedule === 'daily' ? `₹${f.recommendedDaily}/day` :
                                    `₹${f.currentMonthBalance.toLocaleString()} Due`}
                                                    </span>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Render Available Funds
                const availableFundsDiv = document.getElementById('availableFunds');
                const joinedIds = summary.funds.map(f => f.fund_id);
                const available = allFunds.filter(f => !joinedIds.includes(f.id) && f.status === 'active');

                if (available.length === 0) {
                    availableFundsDiv.innerHTML = '<div class="col-12"><div class="text-muted text-center py-4">No new funds available at this time.</div></div>';
                } else {
                    availableFundsDiv.innerHTML = available.map(f => `
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm text-center h-100">
                                <div class="card-body d-flex flex-column h-100">
                                    <h6 class="fw-bold">${f.name}</h6>
                                    <p class="small text-muted mb-3">Total Amount: <strong>₹${Number(f.total_amount).toLocaleString()}</strong></p>
                                    <div class="mt-auto">
                                        <button class="btn btn-outline-primary btn-sm w-100" onclick="showJoinModal(${f.id}, '${f.name}')">
                                            Join This Fund
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Fill select for payment
                document.getElementById('selFund').innerHTML = summary.funds.map(f => `<option value="${f.fund_id || f.id}">${f.name}</option>`).join('');

            } catch (error) { console.error(error); }
        }

        function showJoinModal(id, name) {
            document.getElementById('joinFundId').value = id;
            document.getElementById('joinFundName').value = name;
            const modal = new bootstrap.Modal(document.getElementById('joinModal'));
            modal.show();
        }

        document.getElementById('joinForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                fund_id: document.getElementById('joinFundId').value,
                payment_schedule: document.getElementById('paymentSchedule').value
            };
            try {
                await apiRequest('/funds/join', 'POST', data, Auth.getToken());
                bootstrap.Modal.getInstance(document.getElementById('joinModal')).hide();
                loadDashboard();
                alert('Success! You joined the fund.');
            } catch (err) { alert(err.message); }
        });

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                fund_id: document.getElementById('selFund').value,
                amount: document.getElementById('amount').value,
                payment_month: document.getElementById('pay_month').value,
                payment_schedule: document.getElementById('payment_schedule').value,
                mode: document.getElementById('mode').value,
                payment_date: document.getElementById('date').value
            };
            try {
                await apiRequest('/payments', 'POST', formData, Auth.getToken());
                bootstrap.Modal.getInstance(document.getElementById('payModal')).hide();
                loadDashboard();
                alert('Payment recorded successfully!');
            } catch (err) { alert(err.message); }
        });

        loadDashboard();
    </script>
</body>

</html>